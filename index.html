<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="color-scheme" content="light dark">
<title>DASS-21 Self-Assessment (UiTMCPP)</title>
<style>
/* ===== UiTM Dark Navy Edition ===== */
:root{
  --bg:#00023E;       /* deep navy blue background */
  --ink:#ffffff;      /* main text white */
  --muted:#e0e7ff;    /* soft secondary text */
  --card:#060a57;     /* slightly lighter navy surface */
  --border:#11187a;   /* border tone */

  /* UiTM signature accents */
  --accent:#f0b429;   /* UiTM gold */
  --accent2:#5a2e8a;  /* UiTM purple */

  /* Severity colors */
  --ok:#34d399; --mild:#fbbf24; --mod:#fb923c; --sev:#ef4444; --xsev:#f43f5e;
}

*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.wrap{max-width:980px;margin:28px auto;padding:20px}
header{display:block;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:12px}

/* Masthead */
.masthead{display:flex;align-items:center;gap:18px;margin-bottom:8px}
.uitm-logo{
  flex:0 0 70px;height:70px;display:flex;align-items:center;justify-content:center;
  background:#ffffff;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:6px;
  box-shadow:0 0 12px rgba(255,255,255,.08);
}
.uitm-logo img{max-height:58px;width:auto;display:block}
.uitm-logo .fallback{
  display:none;width:100%;height:100%;border-radius:10px;
  background:linear-gradient(135deg,#5a2e8a,#f0b429);color:#fff;font-weight:800;align-items:center;justify-content:center
}
.titles h2{margin:0;font-size:20px;letter-spacing:.3px;text-transform:uppercase;line-height:1.2;font-weight:800}
.titles h3{margin:2px 0 0;font-size:16px;letter-spacing:.3px;text-transform:uppercase;line-height:1.2;font-weight:800}

.toolbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}

/* Primary button â€” HIGH CONTRAST in both themes */
.primary{
  background:linear-gradient(90deg,var(--accent),var(--accent2)); /* gold â†’ purple */
  color:#0b0b0b; border:2px solid rgba(255,255,255,.22); border-radius:12px;
  font-weight:800; letter-spacing:.2px;
  text-shadow:0 1px 0 rgba(255,255,255,.35); /* boost legibility on navy */
}
.primary:hover{ filter:brightness(1.06); box-shadow:0 0 0 3px rgba(240,180,41,.25); }
.primary:focus-visible{ outline:3px solid #6ee7ff; outline-offset:2px; }

.ghost{background:transparent;border:1px solid rgba(255,255,255,.28);color:var(--ink)}
.okbtn{background:rgba(52,211,153,.18);border:1px solid rgba(52,211,153,.6);color:#e7fff5}

/* Cards & layout */
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 8px 24px rgba(0,0,0,.22);padding:18px;margin:14px 0}
.muted{color:var(--muted)}
.legend{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:8px}
.chip{padding:6px 10px;border-radius:12px;border:1px solid #19248e;font-size:12px;text-align:center;color:var(--muted);background:#0b1482}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:860px){.grid{grid-template-columns:1.5fr .9fr}}

/* Questions */
.q{padding:16px;border-radius:14px;background:#0b1482;border:1px solid var(--border)}
.q h3{margin:0 0 10px;font-size:16px;line-height:1.4;white-space:pre-line}
.opts{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}

/* Options */
.opt{
  padding:10px;border:1px solid #2b4fb6;border-radius:10px;text-align:center;
  cursor:pointer;background:#1144a4;color:#eef3ff;transition:all .15s ease;
}
.opt:hover{background:#1652c7;border-color:#7dd3fc}
input[type=radio]{display:none}
input[type=radio]:checked + .opt{
  border-color:var(--accent);
  background:linear-gradient(180deg,rgba(240,180,41,.42),rgba(90,46,138,.28));
  color:#0b0b0b;font-weight:800;box-shadow:0 0 0 3px rgba(240,180,41,.35);
}

/* Results */
.result h2{margin:0 0 6px}
.scores{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
.score{padding:14px;border-radius:14px;border:1px solid var(--border);background:#0b1482}
.score .num{font-size:28px;font-weight:800}
.sev{font-weight:800}
.sev.normal{color:var(--ok)} .sev.mild{color:var(--mild)} .sev.moderate{color:var(--mod)} .sev.severe{color:var(--sev)} .sev.extreme{color:var(--xsev)}
.disclaimer{font-size:13px;line-height:1.45}
.req{color:#ffe08a;font-weight:700}
footer{margin-top:24px;color:var(--muted);font-size:12px}
.result hr{border:none;border-top:1px solid var(--border)}

/* Links */
a{color:#7dd3fc}

/* ===== Corner Ribbon (UiTM) ===== */
.brand-ribbon{
  position:fixed; inset:0 auto auto 0; width:128px; height:128px; z-index:1000; pointer-events:none;
}
.brand-ribbon .ribbon-bar{
  position:absolute; top:-44px; left:-44px; width:240px; height:64px;
  background:linear-gradient(90deg,var(--accent2),var(--accent));
  transform:rotate(-45deg); box-shadow:0 10px 24px rgba(0,0,0,.25); border-radius:6px;
}
.brand-ribbon .ribbon-logo{
  position:absolute; top:14px; left:14px; width:56px; height:auto;
  background:#fff; padding:7px; border-radius:12px; border:1px solid rgba(0,0,0,.08);
  box-shadow:0 6px 18px rgba(0,0,0,.22);
}
@media (max-width:520px){
  .brand-ribbon{ width:100px; height:100px; }
  .brand-ribbon .ribbon-bar{ top:-36px; left:-36px; width:196px; height:54px; }
  .brand-ribbon .ribbon-logo{ top:12px; left:12px; width:48px; padding:6px; }
}
@media print{ .brand-ribbon{ display:none } }

/* ===== Toggled theme = Classic LIGHT (white UI) ===== */
body.dark{
  --bg:#ffffff; --ink:#111827; --muted:#4b5563; --card:#ffffff; --border:#e5e7eb;
  --accent:#5a2e8a; --accent2:#f0b429;
}
body.dark{ background:var(--bg); color:var(--ink); }
body.dark .card{ background:var(--card); border:1px solid var(--border); }
body.dark header{ border-bottom:1px solid var(--border); }
body.dark .q, body.dark .score{ background:#fafafa; border:1px solid var(--border); }
body.dark .chip{ border:1px solid rgba(17,24,39,.15); color:#4b5563; background:#fff; }
body.dark .ghost{ border:1px solid rgba(17,24,39,.16); color:#111827; }
body.dark .opt{ background:#fff; color:#111827; border:1px solid #cbd5e1; }
body.dark .opt:hover{ background:#eef2ff; border-color:#5b21b6; }
/* Primary button override in Classic Light for max contrast */
body.dark .primary{
  background:linear-gradient(90deg,#5a2e8a,#f0b429); color:#111827; border:2px solid rgba(17,24,39,.22); text-shadow:none;
}
body.dark .primary:hover{ filter:brightness(1.05); box-shadow:0 0 0 3px rgba(90,46,138,.22); }
</style>
</head>
<body>

<!-- Corner Ribbon (UiTM) -->
<a class="brand-ribbon" aria-label="UiTM">
  <span class="ribbon-bar"></span>
  <img src="uitm-logo.png" alt="Universiti Teknologi MARA" class="ribbon-logo" onerror="this.style.display='none'">
</a>

<div class="wrap">
  <header>
    <div class="masthead">
      <div class="uitm-logo">
        <img alt="Universiti Teknologi MARA" src="uitm-logo.png" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
        <div class="fallback">UiTM</div>
      </div>
      <div class="titles">
        <h2>PUSAT TERAPI CARA KERJA</h2>
        <h3>FAKULTI SAINS KESIHATAN, UiTMCPP KAMPUS BERTAM</h3>
      </div>
    </div>
    <div class="toolbar">
      <button class="ghost" id="btnPrint" title="Print or save as PDF">Print / <em>Cetak</em></button>
      <button class="ghost" id="btnReset" title="Clear all responses">Reset / <em>Set semula</em></button>
      <button class="ghost" id="themeToggle" title="Toggle theme">High Contrast Navy ðŸŒ™</button>
      <button class="ghost" id="btnAdmin" title="Author login">Author Login</button>
    </div>
  </header>

  <!-- Intro -->
  <section class="card" id="introCard">
    <h2 style="margin:0 0 4px;text-transform:uppercase">DEPRESSION, ANXIETY AND STRESS SCALE (DASS-21)</h2>
    <p style="margin:6px 0 6px">
      The DASS is a self-screening test designed to measure symptoms of depression, anxiety, and stress. It helps your therapist understand your current condition and plan appropriate treatment. This screening has 21 statements. Please respond based on your experience over the past <strong>WEEK</strong>. There are no right or wrong answers.
      <br><em>DASS ialah ujian saringan kendiri untuk mengukur simptom kemurungan, kebimbangan, dan tekanan. Ia membantu terapis memahami keadaan semasa anda dan merancang rawatan yang sesuai. Ujian ini mempunyai 21 pernyataan. Sila jawab berdasarkan pengalaman <strong>SEMINGGU</strong> yang lepas. Tiada jawapan betul atau salah.</em>
    </p>
  </section>

  <!-- PDPA + Demographic -->
  <section class="card" id="consentCard">
    <h2 style="margin:0 0 8px">Consent &amp; PDPA / <em>Persetujuan &amp; PDPA</em></h2>
    <p class="muted" style="margin:0 0 8px">
      <strong>Statement:</strong> I consent for the information collected on this site to be used for service audit and research in aggregate without personal identifiers. No name/IC is recorded; only general demographics and DASS-21 scores are stored.
      <br><em><strong>Pernyataan:</strong> Saya bersetuju bahawa maklumat yang dikumpul melalui laman ini digunakan untuk audit perkhidmatan dan penyelidikan secara agregat tanpa identiti peribadi. Tiada nama/IC direkodkan; hanya demografik umum dan skor DASS-21 disimpan.</em>
    </p>
    <label style="display:flex;align-items:center;gap:10px;margin:8px 0 16px 0">
      <input id="pdpa" type="checkbox"> <span class="muted">I agree / <em>Saya bersetuju</em></span>
    </label>

    <h3 style="margin:0 0 8px">Please tick where suitable / <em>Sila tandakan yang bersesuaian</em></h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div>
        <div style="font-weight:700;margin-bottom:6px">I am a / <em>Saya adalah</em></div>
        <label style="display:flex;align-items:center;gap:8px;margin:6px 0">
          <input type="checkbox" name="role" value="Student"> <span>Student / <em>Pelajar</em></span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin:6px 0">
          <input type="checkbox" name="gender_ck" value="Male"> <span>Male / <em>Lelaki</em></span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin:6px 0">
          <input type="checkbox" name="gender_ck" value="Female"> <span>Female / <em>Wanita</em></span>
        </label>
      </div>
      <div>
        <div style="font-weight:700;margin-bottom:6px">Age range / <em>Umur</em></div>
        <label style="display:flex;align-items:center;gap:8px;margin:6px 0">
          <input type="checkbox" name="age_band" value="18â€“25"> <span>18â€“25</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin:6px 0">
          <input type="checkbox" name="age_band" value="26â€“35"> <span>26â€“35</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin:6px 0">
          <input type="checkbox" name="age_band" value="36â€“45"> <span>36â€“45</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin:6px 0">
          <input type="checkbox" name="age_band" value="45+"> <span>45+ / <em>45 ke atas</em></span>
        </label>
      </div>
    </div>
  </section>

  <!-- Scale instructions -->
  <section class="card" id="scaleCard">
    <p class="muted" style="margin:0 0 8px">
      Please read each statement and choose a number from 0â€“3 for how much it applied to you <strong>OVER THE PAST WEEK</strong>. There are no right or wrong answers; do not spend too much time on any statement.
      <br><em>Sila baca setiap pernyataan dan pilih nombor 0â€“3 mengikut sejauh mana ia berlaku kepada anda <strong>DALAM SEMINGGU LEPAS</strong>. Tiada jawapan betul atau salah; jangan ambil masa terlalu lama.</em>
      <br>Rating scale:
    </p>
    <div class="legend">
      <div class="chip"><strong>0</strong> Did not apply to me at all <br><em>Tidak pernah sama sekali</em></div>
      <div class="chip"><strong>1</strong> Applied to me to some degree, or some of the time <br><em>Jarang</em></div>
      <div class="chip"><strong>2</strong> Applied to me to a considerable degree, or a good part of time <br><em>Kerap</em></div>
      <div class="chip"><strong>3</strong> Applied to me very much, or most of the time <br><em>Sangat kerap</em></div>
    </div>
  </section>

  <!-- Main grid -->
  <main class="grid" style="margin-top:16px">
    <section class="card">
      <form id="dassForm">
        <div id="questions"></div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
          <button type="button" class="primary" id="btnScore">Calculate Score / <em>Kira Skor</em></button>
          <span class="muted" id="progress">0/21 answered / <em>dijawab</em></span>
        </div>
        <p class="muted" style="margin-top:8px">Fields marked <span class="req">*</span> are required.</p>
      </form>
    </section>

    <aside class="card result" id="results" aria-live="polite" aria-atomic="true">
      <h2>Result / <em>Keputusan</em></h2>
      <div class="scores" id="scores">
        <div class="score" id="scoreDep">
          <div class="muted">Depression</div>
          <div class="num" data-num>0</div>
          <div class="sev normal" data-sev>Normal</div>
        </div>
        <div class="score" id="scoreAnx">
          <div class="muted">Anxiety</div>
          <div class="num" data-num>0</div>
          <div class="sev normal" data-sev>Normal</div>
        </div>
        <div class="score" id="scoreStr">
          <div class="muted">Stress</div>
          <div class="num" data-num>0</div>
          <div class="sev normal" data-sev>Normal</div>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="okbtn" id="btnCopy">Copy Summary / <em>Salin ringkasan</em></button>
        <button class="ghost" id="btnClearResults">Clear / <em>Kosongkan</em></button>
        <button class="primary" id="btnDownloadCSV" title="Download CSV (author only)" style="display:none">Download CSV</button>
        <button class="ghost" id="btnSaveSheet" title="Save to Google Sheet (author only)" disabled style="display:none">Save to Sheet</button>
      </div>
      <hr>
      <div class="disclaimer">
        <strong>Disclaimer:</strong> This tool is for screening/education, not a diagnosis. If your scores are Moderate or higher, consider consulting a qualified clinician.
        <br><em>Penafian: Alat ini untuk saringan/pendidikan, bukan diagnosis. Jika skor anda Moderate atau lebih tinggi, pertimbangkan untuk berjumpa pengamal klinikal bertauliah.</em>
      </div>
    </aside>
  </main>

  <footer>DASS-21 items Â© P. F. Lovibond &amp; S. H. Lovibond.</footer>
</div>

<script>
/* ====== 0) HARD-CODED ENDPOINT â€” GANTI SEKALI SAHAJA ====== */
const SHEET_ENDPOINT = 'PASTE_WEB_APP_URL_HERE?token=ptckb2025'; // << GANTI SEKALI SAHAJA

/* ===== Theme toggle ===== */
const themeBtn = document.getElementById('themeToggle');
function applySavedTheme(){
  const saved = localStorage.getItem('theme') || 'navy';
  if(saved === 'classic'){ document.body.classList.add('dark'); }
  themeBtn.textContent = (saved === 'classic') ? 'Classic Light â˜€ï¸' : 'High Contrast Navy ðŸŒ™';
}
applySavedTheme();
themeBtn.addEventListener('click', ()=>{
  const isClassic = document.body.classList.toggle('dark');
  localStorage.setItem('theme', isClassic ? 'classic' : 'navy');
  themeBtn.textContent = isClassic ? 'Classic Light â˜€ï¸' : 'High Contrast Navy ðŸŒ™';
});

/* ---------------- Questions (BM+EN, blinded) ---------------- */
const items = [
  { id:1,  text:"1. Saya rasa susah untuk bertenang\nI found it hard to wind down" },
  { id:2,  text:"2. Saya sedar mulut saya rasa kering\nI was aware of dryness of my mouth" },
  { id:3,  text:"3. Saya seolah-olah tidak dapat mengalami perasaan positif sama sekali\nI couldnâ€™t seem to experience any positive feeling at all" },
  { id:4,  text:"4. Saya mengalami kesukaran bernafas (contoh: bernafas terlalu cepat, tercungap-cungap walaupun tidak melakukan aktiviti fizikal)\nI experienced breathing difficulty (e.g., excessively rapid breathing, breathlessness in the absence of physical exertion)" },
  { id:5,  text:"5. Saya rasa tidak bersemangat untuk memulakan sesuatu keadaan\nI found it difficult to work up the initiative to do things" },
  { id:6,  text:"6. Saya cenderung bertindak secara berlebihan kepada sesuatu keadaan\nI tended to over-react to situations" },
  { id:7,  text:"7. Saya pernah menggeletar (contohnya tangan)\nI experienced trembling (e.g., in the hands)" },
  { id:8,  text:"8. Saya rasa terlalu gelisah\nI felt that I was using a lot of nervous energy" },
  { id:9,  text:"9. Saya risau akan berlaku keadaan di mana saya panik dan berkelakuan bodoh\nI was worried about situations in which I might panic and make a fool of myself" },
  { id:10, text:"10. Saya rasa tidak ada yang saya harapkan (putus harapan)\nI felt that I had nothing to look forward to" },
  { id:11, text:"11. Saya dapati saya mudah resah\nI found myself getting agitated" },
  { id:12, text:"12. Saya merasa sukar untuk relaks\nI found it difficult to relax" },
  { id:13, text:"13. Saya rasa muram dan sedih\nI felt down-hearted and blue" },
  { id:14, text:"14. Saya tidak boleh terima apa jua yang menghalangi saya daripada meneruskan apa yang saya sedang lakukan\nI was intolerant of anything that kept me from getting on with what I was doing" },
  { id:15, text:"15. Saya rasa hampir panik\nI felt I was close to panic" },
  { id:16, text:"16. Saya tidak bersemangat langsung\nI was unable to become enthusiastic about anything" },
  { id:17, text:"17. Saya rasa diri saya tidak berharga\nI felt I wasnâ€™t worth much as a person" },
  { id:18, text:"18. Saya mudah tersinggung\nI felt that I was rather touchy" },
  { id:19, text:"19. Walaupun saya tidak melakukan aktiviti fizikal, saya sedar akan debaran jantung saya (contoh: degupan jantung lebih cepat)\nI was aware of the action of my heart in the absence of physical exertion (e.g., sense of heart rate increase, heart missing a beat)" },
  { id:20, text:"20. Saya rasa takut tanpa sebab\nI felt scared without any good reason" },
  { id:21, text:"21. Saya rasa hidup ini tidak bererti lagi\nI felt that life was meaningless" }
];

// domain sets
const dep = new Set([3,5,10,13,16,17,21]);
const anx = new Set([2,4,7,9,15,19,20]);
const str = new Set([1,6,8,11,12,14,18]);

// render questions
const qsEl = document.getElementById('questions');
items.forEach(({id,text})=>{
  const block = document.createElement('div');
  block.className='q';
  block.innerHTML = `
    <h3>${text} <span class="req">*</span></h3>
    <div class="opts" role="radiogroup" aria-label="Question ${id}">
      ${[0,1,2,3].map(v=>`
        <label>
          <input type="radio" name="q${id}" value="${v}" aria-label="${v}">
          <div class="opt"><strong>${v}</strong></div>
        </label>
      `).join('')}
    </div>`;
  qsEl.appendChild(block);
});

const form = document.getElementById('dassForm');
const btnScore = document.getElementById('btnScore');
const btnReset = document.getElementById('btnReset');
const btnPrint = document.getElementById('btnPrint');
const btnCopy = document.getElementById('btnCopy');
const btnClearResults = document.getElementById('btnClearResults');
const progress = document.getElementById('progress');

function answeredCount(){ let c=0; for(let i=1;i<=21;i++){ if(form.querySelector(`input[name=q${i}]:checked`)) c++; } return c; }
function updateProgress(){ progress.textContent = `${answeredCount()}/21 answered / dijawab`; }
form.addEventListener('change', updateProgress); updateProgress();

function calc(){
  let missing=[]; const vals={};
  for(let i=1;i<=21;i++){
    const sel = form.querySelector(`input[name=q${i}]:checked`);
    if(!sel) missing.push(i); else vals[i]=Number(sel.value);
  }
  if(missing.length){ alert(`Please answer all questions. Missing: ${missing.join(', ')}`); return null; }
  let sDep=0,sAnx=0,sStr=0;
  for(let i=1;i<=21;i++){
    const v = vals[i];
    if(dep.has(i)) sDep+=v; else if(anx.has(i)) sAnx+=v; else if(str.has(i)) sStr+=v;
  }
  return {Depression:sDep, Anxiety:sAnx, Stress:sStr}; // raw (no Ã—2)
}

function severity(domain,score){
  if(domain==='Depression'){
    if(score>=14) return {label:'Extremely Severe',cls:'extreme'};
    if(score>=11) return {label:'Severe',cls:'severe'};
    if(score>=8)  return {label:'Moderate',cls:'moderate'};
    if(score>=6)  return {label:'Mild',cls:'mild'};
    return {label:'Normal',cls:'normal'};
  }
  if(domain==='Anxiety'){
    if(score>=11) return {label:'Extremely Severe',cls:'extreme'};
    if(score>=9)  return {label:'Severe',cls:'severe'};
    if(score>=7)  return {label:'Moderate',cls:'moderate'};
    if(score>=5)  return {label:'Mild',cls:'mild'};
    return {label:'Normal',cls:'normal'};
  }
  // Stress
  if(score>=18) return {label:'Extremely Severe',cls:'extreme'};
  if(score>=14) return {label:'Severe',cls:'severe'};
  if(score>=10) return {label:'Moderate',cls:'moderate'};
  if(score>=8)  return {label:'Mild',cls:'mild'};
  return {label:'Normal',cls:'normal'};
}

function paint(scores){
  const nodes = {
    Depression: document.querySelector('#scoreDep'),
    Anxiety: document.querySelector('#scoreAnx'),
    Stress: document.querySelector('#scoreStr'),
  };
  for(const k of Object.keys(nodes)){
    const el = nodes[k];
    const num = el.querySelector('[data-num]');
    const sev = el.querySelector('[data-sev]');
    const band = severity(k, scores[k]);
    num.textContent = String(scores[k]);
    sev.textContent = band.label;
    sev.className = `sev ${band.cls}`;
  }
}

/* ====== PDPA + Save controls ====== */
const pdpa = document.getElementById('pdpa');
const btnSaveSheet = document.getElementById('btnSaveSheet');
pdpa.addEventListener('change', ()=>{ btnSaveSheet.disabled = !pdpa.checked; });

/* --------------- Google Sheet (Apps Script) --------------- */
async function saveToSheet(){
  if(!pdpa.checked){ alert('Please tick PDPA consent first. / Sila tandakan persetujuan PDPA dahulu.'); return; }
  if(!SHEET_ENDPOINT){ alert('SHEET_ENDPOINT belum diisi. Sila set URL Web App /exec'); return; }

  const d = document.querySelector('#scoreDep [data-num]').textContent;
  const a = document.querySelector('#scoreAnx [data-num]').textContent;
  const s = document.querySelector('#scoreStr [data-num]').textContent;
  const ds = document.querySelector('#scoreDep [data-sev]').textContent;
  const as = document.querySelector('#scoreAnx [data-sev]').textContent;
  const ss = document.querySelector('#scoreStr [data-sev]').textContent;

  const payload = {
    timestamp: new Date().toISOString(),
    id: '',
    role: Array.from(document.querySelectorAll('input[name=role]:checked')).map(el=>el.value).join('|'),
    gender: Array.from(document.querySelectorAll('input[name=gender_ck]:checked')).map(el=>el.value).join('|'),
    age_band: Array.from(document.querySelectorAll('input[name=age_band]:checked')).map(el=>el.value).join('|'),
    depression: Number(d||0), anxiety: Number(a||0), stress: Number(s||0),
    sev_depression: ds, sev_anxiety: as, sev_stress: ss,
    theme: (document.body.classList.contains('dark') ? 'classic' : 'navy')
  };

  const res = await fetch(SHEET_ENDPOINT,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  if(!res.ok){
    const txt = await res.text().catch(()=>String(res.status));
    throw new Error(txt || ('HTTP '+res.status));
  }
}

/* ====== Score/Reset/Print/Copy/CSV ====== */
document.getElementById('btnScore').addEventListener('click', async ()=>{
  const scores = calc(); if(!scores) return;
  paint(scores);

  // === Auto-append bila PDPA setuju & endpoint sudah di-set ===
  try{
    if (pdpa.checked && SHEET_ENDPOINT) {
      await saveToSheet();
    }
  }catch(e){
    console.warn('Auto-append failed:', e);
  }
});

document.getElementById('btnReset').addEventListener('click', ()=>{
  document.getElementById('dassForm').reset(); updateProgress(); paint({Depression:0,Anxiety:0,Stress:0});
});
document.getElementById('btnPrint').addEventListener('click', ()=>{ window.print(); });

document.getElementById('btnCopy').addEventListener('click', ()=>{
  const d = document.querySelector('#scoreDep [data-num]').textContent;
  const a = document.querySelector('#scoreAnx [data-num]').textContent;
  const s = document.querySelector('#scoreStr [data-num]').textContent;
  const ds = document.querySelector('#scoreDep [data-sev]').textContent;
  const as = document.querySelector('#scoreAnx [data-sev]').textContent;
  const ss = document.querySelector('#scoreStr [data-sev]').textContent;
  const demo = [
    Array.from(document.querySelectorAll('input[name=role]:checked')).map(el=>el.value).join('|'),
    Array.from(document.querySelectorAll('input[name=gender_ck]:checked')).map(el=>el.value).join('|'),
    Array.from(document.querySelectorAll('input[name=age_band]:checked')).map(el=>el.value).join('|'),
  ].filter(Boolean).join(' â€¢ ');
  const txt = `DASS-21 Summary
Depression: ${d} (${ds})
Anxiety: ${a} (${as})
Stress: ${s} (${ss})${demo?`\nDemo: ${demo}`:''}`;
  navigator.clipboard.writeText(txt).then(()=>{ 
    const btn = document.getElementById('btnCopy');
    btn.textContent='Copied!';
    setTimeout(()=>btn.textContent='Copy Summary / Salin ringkasan',1200);
  });
});

/* --------------- CSV helpers (author only â€” hidden by default) --------------- */
function generateCSVString(row){
  const headers = ['timestamp','id','role','gender','age_band','depression','anxiety','stress','sev_depression','sev_anxiety','sev_stress'];
  const headerLine = headers.join(',');
  const valueLine = headers.map(h=>JSON.stringify(row[h] ?? '')).join(',');
  return [headerLine, valueLine].join('\n');
}
function downloadCSV(row){
  const csv = generateCSVString(row);
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const ts = new Date().toISOString().replaceAll(':','-');
  a.download = `dass21_${ts}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
}
function currentResultRow(){
  const d = document.querySelector('#scoreDep [data-num]').textContent;
  const a = document.querySelector('#scoreAnx [data-num]').textContent;
  const s = document.querySelector('#scoreStr [data-num]').textContent;
  const ds = document.querySelector('#scoreDep [data-sev]').textContent;
  const as = document.querySelector('#scoreAnx [data-sev]').textContent;
  const ss = document.querySelector('#scoreStr [data-sev]').textContent;
  return {
    timestamp: new Date().toISOString(),
    id: '',
    role: Array.from(document.querySelectorAll('input[name=role]:checked')).map(el=>el.value).join('|'),
    gender: Array.from(document.querySelectorAll('input[name=gender_ck]:checked')).map(el=>el.value).join('|'),
    age_band: Array.from(document.querySelectorAll('input[name=age_band]:checked')).map(el=>el.value).join('|'),
    depression: Number(d||0), anxiety: Number(a||0), stress: Number(s||0),
    sev_depression: ds, sev_anxiety: as, sev_stress: ss,
  };
}

/* --------------- Author access control (optional UI later) --------------- */
const ADMIN_PASSWORD = 'ptckb2025';
const btnAdmin = document.getElementById('btnAdmin');
const btnDownloadCSVEl = document.getElementById('btnDownloadCSV');
function setAdminMode(on){
  if(on){
    localStorage.setItem('dass_admin','1');
    btnAdmin.textContent='Author: Logout';
    btnDownloadCSVEl.style.display='inline-block';
    btnSaveSheet.style.display='inline-block';
  }else{
    localStorage.removeItem('dass_admin');
    btnAdmin.textContent='Author Login';
    btnDownloadCSVEl.style.display='none';
    btnSaveSheet.style.display='none';
  }
}
setAdminMode(localStorage.getItem('dass_admin')==='1');
btnAdmin.addEventListener('click', ()=>{
  const isAdmin = localStorage.getItem('dass_admin')==='1';
  if(isAdmin){ setAdminMode(false); return; }
  const pw = prompt('Author password:');
  if(pw===ADMIN_PASSWORD){ setAdminMode(true); alert('Author mode enabled'); }
  else if(pw!==null){ alert('Wrong password'); }
});

/* --------------- Self-test (silent) --------------- */
try{
  const _row = {timestamp:'2025-11-04T00:00:00Z',id:'',role:'Student',gender:'Female',age_band:'26â€“35',depression:10,anxiety:8,stress:14,sev_depression:'Mild',sev_anxiety:'Normal',sev_stress:'Normal'};
  const _csv = generateCSVString(_row);
  console.assert(_csv.split('\n').length===2, 'CSV 2 lines');
  console.assert(_csv.startsWith('timestamp,id,role'), 'CSV header ok');
}catch(e){ console.warn('Self-test failed:', e); }
</script>
</body>
</html>
